/* eslint-disable @typescript-eslint/ban-ts-comment */
import { Dialog, Menu, Transition } from '@headlessui/react';
import {
	CheckIcon,
	EllipsisVerticalIcon,
	HandThumbUpIcon,
	UserIcon,
} from '@heroicons/react/20/solid';
import { XMarkIcon } from '@heroicons/react/24/outline';
import { Fragment, useState } from 'react';
import { useParams } from 'react-router-dom';

import { getFormattedDescriptionItem } from '../../../helpers/jiraDescFormatter';
import { trpc } from '../../trpc';

const statuses = {
	Complete: 'text-green-700 bg-green ring-green-600/20',
	'To Do': 'text-gray-400 bg-gray ring-gray-400/20',
	'In progress': 'text-yellow-800 bg-yellow ring-yellow-600/20',
};

function classNames(...classes: any[]) {
	return classes.filter(Boolean).join(' ');
}

export const UserStoriesList = () => {
	const [isPanelOpen, setIsPanelOpen] = useState(false);
	const [panelId, setPanelId] = useState('');

	const { projectId } = useParams<{ projectId: string }>();
	const userStoriesQuery = trpc.userStories.getUserStories.useQuery(
		{
			projectId: projectId!,
		},
		{
			enabled: !!projectId,
			staleTime: 1000,
			retry: (retry, error) => {
				return retry < 3 && !error.data?.code;
			},
		}
	);
	const userStories = userStoriesQuery.data;
	console.log('userStories:', userStories);

	const openSidebar = (id: string) => {
		setPanelId(id);
		setIsPanelOpen(true);
	};

	return (
		<div>
			<ul role="list" className="divide-y divide-gray-800">
				{userStories?.map((userStory) => {
					// @ts-ignore
					const status = statuses[userStory.fields?.status.name || ''];

					return (
						<li key={userStory.id} className="flex items-center justify-between gap-x-6 py-5">
							<div className="min-w-0">
								<div className="flex items-start gap-x-3">
									{/* TODO: make href dynamic */}
									<a
										href={`https://opentestcase.atlassian.net/browse/${userStory.key}`}
										target="_blank"
										rel="noreferrer"
										className="text-sm font-semibold leading-6 text-gray-400"
									>
										{userStory?.key}
									</a>
									<p className="text-sm font-semibold leading-6 text-white">
										{userStory.fields?.summary}
									</p>
									<p
										className={classNames(
											status,
											'rounded-md whitespace-nowrap mt-0.5 px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset'
										)}
									>
										{userStory.fields?.status.name || ''}
									</p>
								</div>
								<div className="mt-1 flex items-center gap-x-2 text-xs leading-5 text-gray-500">
									<p className="truncate">
										{userStory.fields?.attachment?.length &&
											`${userStory.fields?.attachment?.length} attachment${
												userStory.fields?.attachment?.length > 1 ? 's' : ''
											} â€” `}
										Created by {userStory.fields?.creator.displayName}
										{userStory.fields?.created
											? ` on ${new Date(userStory.fields?.created).toLocaleString()}`
											: ''}
									</p>
								</div>
							</div>
							<div className="flex flex-none items-center gap-x-4">
								<a
									onClick={() => openSidebar(`${userStory.id}`)}
									className="rounded-md bg-white/10 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-white/20"
								>
									View details
								</a>
								<Menu as="div" className="relative flex-none">
									<Menu.Button className="-m-2.5 block p-2.5 text-gray-500 hover:text-white">
										<span className="sr-only">Open options</span>
										<EllipsisVerticalIcon className="h-5 w-5" aria-hidden="true" />
									</Menu.Button>
									<Transition
										as={Fragment}
										enter="transition ease-out duration-100"
										enterFrom="transform opacity-0 scale-95"
										enterTo="transform opacity-100 scale-100"
										leave="transition ease-in duration-75"
										leaveFrom="transform opacity-100 scale-100"
										leaveTo="transform opacity-0 scale-95"
									>
										<Menu.Items className="absolute right-0 z-10 mt-2 w-32 origin-top-right rounded-md bg-slate-700 py-2 shadow-lg ring-1 ring-gray-900/5 focus:outline-none">
											<Menu.Item>
												{({ active }) => (
													<a
														// TODO: make this dynamic
														href={`https://opentestcase.atlassian.net/browse/${userStory.key}`}
														target="_blank"
														rel="noreferrer"
														className={classNames(
															active ? 'bg-slate-600' : 'bg-slate-700',
															'block px-3 py-1 text-sm leading-6 text-white'
														)}
													>
														Open in Jira
													</a>
												)}
											</Menu.Item>
										</Menu.Items>
									</Transition>
								</Menu>
							</div>
						</li>
					);
				})}
			</ul>

			<Panel isOpen={isPanelOpen} setOpen={setIsPanelOpen} id={panelId} />
		</div>
	);
};

function Panel({ isOpen, setOpen }: any) {
	const { projectId } = useParams<{ projectId: string }>();
	const userStoriesQuery = trpc.userStories.getUserStories.useQuery(
		{
			projectId: projectId!,
		},
		{
			enabled: !!projectId,
			staleTime: 1000,
			retry: (retry, error) => {
				return retry < 3 && !error.data?.code;
			},
		}
	);
	const userStories = userStoriesQuery.data;

	const userStory = userStories?.[0];
	console.log('data:', userStory);

	if (!userStory) return null;

	console.log('userStory:', userStory.fields?.description);

	return (
		<Transition.Root show={isOpen} as={Fragment}>
			<Dialog as="div" className="relative z-10" onClose={setOpen}>
				<div className="fixed inset-0" />

				<div className="fixed inset-0 overflow-hidden">
					<div className="absolute inset-0 overflow-hidden">
						<div className="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
							<Transition.Child
								as={Fragment}
								enter="transform transition ease-in-out duration-300 sm:duration-500"
								enterFrom="translate-x-full"
								enterTo="translate-x-0"
								leave="transform transition ease-in-out duration-300 sm:duration-500"
								leaveFrom="translate-x-0"
								leaveTo="translate-x-full"
							>
								<Dialog.Panel className="pointer-events-auto w-screen max-w-2xl ">
									<div className="flex h-full flex-col overflow-y-scroll bg-slate-800 py-6 shadow-xl">
										<div className="px-4 sm:px-6">
											<div className="flex items-start justify-between">
												<Dialog.Title className="flex items-start gap-x-3 text-base font-semibold leading-2 text-white">
													<a
														href={`https://opentestcase.atlassian.net/browse/${userStory.key}`}
														target="_blank"
														rel="noreferrer"
														className="text-gray-400"
													>
														{userStory.key}
													</a>
													<p className="text-white">{userStory.fields?.summary}</p>
												</Dialog.Title>
												<div className="ml-3 flex h-7 items-center">
													<button
														type="button"
														className="relative rounded-md bg-slate-800 text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
														onClick={() => setOpen(false)}
													>
														<span className="absolute -inset-2.5" />
														<span className="sr-only">Close panel</span>
														<XMarkIcon className="h-6 w-6" aria-hidden="true" />
													</button>
												</div>
											</div>
										</div>
										<div className="relative mt-6 flex-1 px-4 sm:px-6">
											<div className="mb-10 flex-1">
												<div className="border-b border-gray-600 pb-5 mb-4">
													<h3 className="text-base font-semibold leading-6 text-white">
														Description
													</h3>
												</div>

												{userStory.fields?.description?.content?.map((item: any) => {
													return (
														<div className="text-gray-300 text-sm">
															{getFormattedDescriptionItem(item)}
														</div>
													);
												})}
											</div>

											<div className="mb-10 flex-1">
												<div className="border-b border-gray-600 pb-5 mb-4">
													<h3 className="text-base font-semibold leading-6 text-white">
														Test cases
													</h3>
												</div>

												<Feed />
											</div>

											<div className="mb-10 flex-1">
												<div className="border-b border-gray-600 pb-5 mb-4">
													<h3 className="text-base font-semibold leading-6 text-white">
														Test cases
													</h3>
												</div>

												<div className="flex-1">
													<p className="text-gray-300 text-sm">No exisiting test cases</p>

													<div className="mt-3">
														<button
															type="button"
															className="rounded-md bg-indigo-600 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
														>
															Generate test cases
														</button>
													</div>
												</div>
											</div>
										</div>
									</div>
								</Dialog.Panel>
							</Transition.Child>
						</div>
					</div>
				</div>
			</Dialog>
		</Transition.Root>
	);
}

const timeline = [
	{
		id: 1,
		content: 'Applied to',
		target: 'Front End Developer',
		href: '#',
		date: 'Sep 20',
		datetime: '2020-09-20',
		icon: UserIcon,
		iconBackground: 'bg-gray-400',
	},
	{
		id: 2,
		content: 'Advanced to phone screening by',
		target: 'Bethany Blake',
		href: '#',
		date: 'Sep 22',
		datetime: '2020-09-22',
		icon: HandThumbUpIcon,
		iconBackground: 'bg-blue-500',
	},
	{
		id: 3,
		content: 'Completed phone screening with',
		target: 'Martha Gardner',
		href: '#',
		date: 'Sep 28',
		datetime: '2020-09-28',
		icon: CheckIcon,
		iconBackground: 'bg-green-500',
	},
	{
		id: 4,
		content: 'Advanced to interview by',
		target: 'Bethany Blake',
		href: '#',
		date: 'Sep 30',
		datetime: '2020-09-30',
		icon: HandThumbUpIcon,
		iconBackground: 'bg-blue-500',
	},
	{
		id: 5,
		content: 'Completed interview with',
		target: 'Katherine Snyder',
		href: '#',
		date: 'Oct 4',
		datetime: '2020-10-04',
		icon: CheckIcon,
		iconBackground: 'bg-green-500',
	},
];

export default function Feed() {
	return (
		<div className="flow-root">
			<ul role="list" className="-mb-8">
				{timeline.map((event, eventIdx) => (
					<li key={event.id}>
						<div className="relative pb-8">
							{eventIdx !== timeline.length - 1 ? (
								<span
									className="absolute left-4 top-4 -ml-px h-full w-0.5 bg-gray-600"
									aria-hidden="true"
								/>
							) : null}
							<div className="relative flex space-x-3">
								<div>
									<span
										className={classNames(
											event.iconBackground,
											'h-8 w-8 rounded-full flex items-center justify-center ring-4 ring-gray-600'
										)}
									>
										<event.icon className="h-5 w-5 text-white" aria-hidden="true" />
									</span>
								</div>
								<div className="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
									<div>
										<p className="text-sm text-gray-300">
											{event.content}{' '}
											<a href={event.href} className="font-medium text-gray-300">
												{event.target}
											</a>
										</p>
									</div>
									<div className="whitespace-nowrap text-right text-sm text-gray-500">
										<time dateTime={event.datetime}>{event.date}</time>
									</div>
								</div>
							</div>
						</div>
					</li>
				))}
			</ul>
		</div>
	);
}
