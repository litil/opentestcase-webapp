import { Dialog, Transition } from '@headlessui/react';
import { XMarkIcon } from '@heroicons/react/24/outline';

import { getFormattedDescriptionItem } from '../../../../helpers/jiraDescFormatter';
import { getTextFormattedDescription } from '../../../../helpers/jiraDescFormatterAsText';
import { trpc } from '../../../trpc';
import { Loader } from '../../Loader/Loader';
import { GenerateCasesButton } from './GenerateCasesButton/GenerateCasesButton';
import { ScoreStoryButton } from './ScoreStoryButton/ScoreStoryButton';
import { ReviewStoryButton } from './ReviewStoryButton/ReviewStoryButton';
import { AutomateCasesButton } from './AutomateCasesButton/AutomateCasesButton';

export const UserStoryPanel = ({
	isOpen,
	setOpen,
	id,
}: {
	isOpen: boolean;
	setOpen: (_: boolean) => void;
	id: string;
}) => {
	const userStoryQuery = trpc.userStories.getUserStory.useQuery({
		jiraDomain: 'opentestcase',
		storyId: id,
	});

	const { data, status } = userStoryQuery;

	const ticketDesc = getTextFormattedDescription(data?.fields?.description?.content);

	return (
		// <Transition.Root show={isOpen} as={Fragment}>
		<Dialog as="div" className="relative z-10" onClose={setOpen} open={isOpen}>
			<div className="fixed inset-0" />

			<div className="fixed inset-0 overflow-hidden">
				<div className="absolute inset-0 overflow-hidden">
					<div className="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
						{/* <Transition.Child
							as={Fragment}
							enter="transform transition ease-in-out duration-300 sm:duration-500"
							enterFrom="translate-x-full"
							enterTo="translate-x-0"
							leave="transform transition ease-in-out duration-300 sm:duration-500"
							leaveFrom="translate-x-0"
							leaveTo="translate-x-full"
						> */}
						<Dialog.Panel className="pointer-events-auto w-screen max-w-2xl ">
							<div className="flex h-full flex-col overflow-y-scroll bg-slate-800 py-6 shadow-xl">
								{status === 'loading' ? (
									<div className="py-20 flex justify-center">
										<div className="inline-flex items-center">
											<div className="pr-2 text-white">
												<Loader size={7} />
											</div>{' '}
											<span className="text-white text-l">Loading...</span>
										</div>
									</div>
								) : (
									<>
										<div className="px-4 sm:px-6">
											<div className="flex items-start justify-between">
												<Dialog.Title className="flex items-start gap-x-3 text-base font-semibold leading-2 text-white">
													<a
														href={`https://opentestcase.atlassian.net/browse/${data.key}`}
														target="_blank"
														rel="noreferrer"
														className="text-gray-400"
													>
														{data?.key}
													</a>
													<p className="text-white">{data?.fields?.summary}</p>
												</Dialog.Title>
												<div className="ml-3 flex h-7 items-center">
													<button
														type="button"
														className="relative rounded-md bg-slate-800 text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
														onClick={() => setOpen(false)}
													>
														<span className="absolute -inset-2.5" />
														<span className="sr-only">Close panel</span>
														<XMarkIcon className="h-6 w-6" aria-hidden="true" />
													</button>
												</div>
											</div>
										</div>
										<div className="relative mt-6 flex-1 px-4 sm:px-6">
											<div className="mb-10 flex-1">
												<div className="border-b border-gray-600 pb-5 mb-4">
													<h3 className="text-base font-semibold leading-6 text-white">
														Description
													</h3>
												</div>

												{data.fields?.description?.content?.map((item: any) => {
													return (
														<div className="text-gray-300 text-sm">
															{getFormattedDescriptionItem(item)}
														</div>
													);
												})}
											</div>

											{/* <div className="mb-10 flex-1">
												<div className="border-b border-gray-600 pb-5 mb-4">
													<h3 className="text-base font-semibold leading-6 text-white">
														Test cases
													</h3>
												</div>

												<Feed />
											</div> */}

											<div className="mb-10 flex-1">
												<div className="border-b border-gray-600 pb-5 mb-4">
													<h3 className="text-base font-semibold leading-6 text-white">
														Test cases
													</h3>
												</div>

												<div className="flex-1">
													<p className="text-gray-300 text-sm">No exisiting test cases</p>

													<div className="mt-3">
														<ScoreStoryButton
															issueType={data.fields?.issuetype?.name}
															description={ticketDesc}
														/>
													</div>

													<div className="mt-3">
														<ReviewStoryButton
															issueType={data.fields?.issuetype?.name}
															description={ticketDesc}
														/>
													</div>

													<div className="mt-3">
														<GenerateCasesButton
															issueType={data.fields?.issuetype?.name}
															description={ticketDesc}
														/>
													</div>

													<div className="mt-3">
														<AutomateCasesButton
															issueType={data.fields?.issuetype?.name}
															description={ticketDesc}
														/>
													</div>
												</div>
											</div>
										</div>
									</>
								)}
							</div>
						</Dialog.Panel>
						{/* </Transition.Child> */}
					</div>
				</div>
			</div>
		</Dialog>
		// </Transition.Root>
	);
};
